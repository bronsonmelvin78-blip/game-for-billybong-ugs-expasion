<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Games Index</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;padding:24px}
  h1{margin-bottom:12px}
  #list{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .card{padding:12px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;display:block;text-decoration:none;color:inherit}
  .card:hover{box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .meta{color:#666;font-size:13px;margin-top:6px}
  .hint{margin-top:18px;color:#555;font-size:14px}
</style>
</head>
<body>
  <h1>BillyBong Game Stash</h1>
  <div id="list">Loading…</div>
  <div class="hint" id="hint"></div>

<script>
async function load() {
  try {
    const res = await fetch('./games.json', {cache: 'no-store'});
    if (!res.ok) throw new Error('games.json missing');
    const games = await res.json();
    const list = document.getElementById('list');
    list.innerHTML = '';
    if (!games.length) { list.innerHTML = '<div>No game files found.</div>'; return; }
    for (const g of games) {
      // make the card an actual link so middle/ctrl-clicks behave like normal links
      const a = document.createElement('a');
      a.className = 'card';
      a.href = g.path;
      a.target = '_blank';
      a.rel = 'noopener';
      a.innerHTML = `<div><strong>${escapeHtml(g.name)}</strong></div>
                     <div class="meta">${escapeHtml(g.path)}</div>`;
      // left-click without modifiers: open about:blank then navigate
      a.addEventListener('click', (e) => {
        if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
        e.preventDefault();
        openInBlankThenNavigate(g.path);
      });
      // middle-click: also use the helper for the interim about:blank
      a.addEventListener('auxclick', (e) => {
        if (e.button === 1 && !e.metaKey && !e.ctrlKey && !e.shiftKey && !e.altKey) {
          e.preventDefault();
          openInBlankThenNavigate(g.path);
        }
      });
      // keyboard Enter
      a.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); openInBlankThenNavigate(g.path); } });
      list.appendChild(a);
    }
  } catch (err) {
    document.getElementById('list').innerHTML = '<div>Unable to load games list.</div>';
    // concise automatic-fallback message; CI will update games.json and site is published to GitHub Pages
    document.getElementById('hint').textContent =
      'The games list is generated automatically on push and published via GitHub Pages; no manual steps are required.';
  }
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}
load();

// new: listen for server-sent events and reload the list when games update
if (typeof EventSource !== 'undefined') {
  try {
    const es = new EventSource('/events');
    es.addEventListener('games-updated', () => {
      console.log('games-updated event received; reloading list');
      load();
    });
    es.onerror = () => { /* network errors will be retried by the browser */ };
  } catch (e) {
    // ignore and fall back to polling
    setInterval(load, 5000);
  }
} else {
  // fallback polling for browsers without EventSource
  setInterval(load, 5000);
}

// new helper: open about:blank first, then navigate (shows about:blank momentarily)
function openInBlankThenNavigate(href) {
  const w = window.open('about:blank', '_blank');
  if (!w) return;
  try {
    // show a minimal "Opening…" blank page (writing may fail on some browsers)
    w.document.write(
      '<!doctype html><meta charset="utf-8"><title>Loading…</title>' +
      '<style>body{background:#fff;color:#333;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}</style>' +
      '<div>Opening…</div>'
    );
    w.document.close();
  } catch (e) {
    // ignore if writing is blocked
  }

  const navigate = () => {
    try { w.location.href = href; return true; } catch (e) {
      try { w.location.replace(href); return true; } catch (e2) { return false; }
    }
  };

  // schedule navigation from the opener (more reliable than relying on a script in the new doc)
  setTimeout(() => {
    if (!navigate()) setTimeout(navigate, 150);
  }, 150);

  // retry a few times if the tab remains on about:blank
  let attempts = 0;
  const maxAttempts = 4;
  const t = setInterval(() => {
    attempts++;
    try {
      if (w.closed) { clearInterval(t); return; }
      if (w.location && w.location.href && w.location.href !== 'about:blank') { clearInterval(t); return; }
    } catch (err) {
      // cross-origin error implies navigation succeeded
      clearInterval(t); return;
    }
    if (attempts >= maxAttempts) {
      try { w.location = href; } catch (_) { /* ignore */ }
      clearInterval(t);
    } else {
      navigate();
    }
  }, 500);
}
</script>
</body>
</html>
