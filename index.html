<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Games Index</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;padding:24px}
  h1{margin-bottom:12px}
  #list{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .card{padding:12px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;display:block;text-decoration:none;color:inherit}
  .card:hover{box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .meta{color:#666;font-size:13px;margin-top:6px}
  .hint{margin-top:18px;color:#555;font-size:14px}
</style>
</head>
<body>
  <h1>BillyBong Game Stash</h1>
  <div id="list">Loadingâ€¦</div>
  <div class="hint" id="hint"></div>

<script>
async function load() {
  try {
    const res = await fetch('./games.json', {cache: 'no-store'});
    if (!res.ok) throw new Error('games.json missing');
    const games = await res.json();
    const list = document.getElementById('list');
    list.innerHTML = '';
    if (!games.length) { list.innerHTML = '<div>No game files found.</div>'; return; }
    for (const g of games) {
      // make the card an actual link that opens about:blank so the new tab stays blank
      const a = document.createElement('a');
      a.className = 'card';
      a.href = 'about:blank';
      a.target = '_blank';
      a.rel = 'noopener';
      a.setAttribute('data-game-href', g.path);
      a.innerHTML = `<div><strong>${escapeHtml(g.name)}</strong></div>
                     <div class="meta">${escapeHtml(g.path)}</div>`;
      // always prevent default navigation and open a blank tab that stays blank
      a.addEventListener('click', (e) => { e.preventDefault(); openBlankAndStay(g); });
      a.addEventListener('auxclick', (e) => { e.preventDefault(); openBlankAndStay(g); });
      a.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); openBlankAndStay(g); } });
      list.appendChild(a);
    }
  } catch (err) {
    document.getElementById('list').innerHTML = '<div>Unable to load games list.</div>';
    // concise automatic-fallback message; CI will update games.json and site is published to GitHub Pages
    document.getElementById('hint').textContent =
      'The games list is generated automatically on push and published via GitHub Pages; no manual steps are required.';
  }
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}
load();

// new: listen for server-sent events and reload the list when games update
if (typeof EventSource !== 'undefined') {
  try {
    const es = new EventSource('/events');
    es.addEventListener('games-updated', () => {
      console.log('games-updated event received; reloading list');
      load();
    });
    es.onerror = () => { /* network errors will be retried by the browser */ };
  } catch (e) {
    // ignore and fall back to polling
    setInterval(load, 5000);
  }
} else {
  // fallback polling for browsers without EventSource
  setInterval(load, 5000);
}

// open about:blank and leave it there (no redirect)
function openBlankAndStay(g) {
  const w = window.open('about:blank', '_blank');
  if (!w) return;
  try {
    const safePath = escapeHtml(g.path);
    w.document.write(
      '<!doctype html><meta charset="utf-8"><title>Blank</title>' +
      '<style>body{background:#fff;color:#333;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;padding:24px;text-align:center}</style>' +
      `<div style="max-width:600px"><strong>Opened blank for ${escapeHtml(g.name)}</strong><div style="margin-top:12px;color:#666">${safePath}</div></div>`
    );
    w.document.close();
  } catch (e) {
    // ignore if writing is blocked; the tab will remain about:blank
  }
}
</script>
</body>
</html>
